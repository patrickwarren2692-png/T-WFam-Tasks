<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-WFam Tasks</title>
    <style>
        :root { --primary: #6366f1; --success: #22c55e; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 120px; }
        .stats-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); margin-bottom: 20px; }
        .progress-container { background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        #progressBar { background: var(--success); height: 100%; width: 0%; transition: width 0.4s ease; }
        .day-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); }
        .day-header { font-weight: 800; color: var(--primary); margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .task-item { background: #f1f5f9; padding: 12px; border-radius: 10px; margin-bottom: 8px; }
        .task-item.completed { opacity: 0.6; background: #dcfce7; }
        .task-item.completed div { text-decoration: line-through; }
        button { border: none; color: white; cursor: pointer; font-weight: bold; -webkit-tap-highlight-color: transparent; }
        .chip-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .chip { padding: 8px 15px; background: #e2e8f0; border-radius: 20px; font-size: 0.85rem; cursor: pointer; font-weight: bold; }
        .chip.active { background: var(--primary); color: white; }
        select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 1rem; }
        #settingsOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; color:white; padding:30px; box-sizing:border-box; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h1 style="font-size:1.4rem; color:var(--primary); margin:0;">T-WFam Tasks</h1>
        <button onclick="openSettings()" style="background:#64748b; padding:8px 15px; border-radius:8px; font-size:0.8rem;">âš™ Settings</button>
    </div>

    <div class="stats-card">
        <h2 id="statsTitle" style="margin:0; font-size:1.1rem;">Family Weekly Progress</h2>
        <div class="progress-container"><div id="progressBar"></div></div>
        <div style="display:flex; justify-content:space-between; font-size:0.9rem; font-weight:bold;">
            <span id="percentLabel">0%</span><span>Completed</span>
        </div>
    </div>

    <div class="chip-container" id="daySelector">
        <div class="chip active" onclick="setDayFilter('All', this)">All</div>
        <div class="chip" onclick="setDayFilter('Monday', this)">Mon</div>
        <div class="chip" onclick="setDayFilter('Tuesday', this)">Tue</div>
        <div class="chip" onclick="setDayFilter('Wednesday', this)">Wed</div>
        <div class="chip" onclick="setDayFilter('Thursday', this)">Thu</div>
        <div class="chip" onclick="setDayFilter('Friday', this)">Fri</div>
        <div class="chip" onclick="setDayFilter('Saturday', this)">Sat</div>
        <div class="chip" onclick="setDayFilter('Sunday', this)">Sun</div>
    </div>

    <div class="stats-card">
        <h3 style="margin-top:0; font-size:1rem;">Add New Task</h3>
        <select id="jobSelect">
            <option value="Vacuuming">Vacuuming</option>
            <option value="Mopping">Mopping</option>
            <option value="Dishes">Dishes</option>
            <option value="Bathroom">Bathroom</option>
            <option value="Laundry">Laundry</option>
            <option value="Rubbish">Rubbish</option>
        </select>
        <select id="nameSelect">
            <option value="Patrick">Patrick</option>
            <option value="Partner">Partner</option>
        </select>
        <button onclick="addTask()" style="background:var(--primary); padding:15px; width:100%; border-radius:10px;">âž• Add Task</button>
    </div>

    <div id="mainDisplay">Loading tasks...</div>

    <div id="settingsOverlay">
        <h2>Admin Settings</h2>
        <hr style="border:0; border-top:1px solid #444; margin-bottom:20px;">
        <button onclick="requestNotificationPermission()" style="background:var(--primary); padding:15px; width:100%; border-radius:10px; margin-bottom:15px;">ðŸ”” Enable Notifications</button>
        <button onclick="resetWeek()" style="background:var(--danger); padding:15px; width:100%; border-radius:10px; margin-bottom:30px;">ðŸš¨ Reset Entire Week</button>
        <button onclick="closeSettings()" style="background:#475569; padding:12px; width:100%; border-radius:10px;">Close Menu</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDQOz-r2LIjk2Eyw19sy7yjzvhxafUFzKI",
            databaseURL: "https://family-clean-d428e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "family-clean-d428e",
            messagingSenderId: "1067832584063",
            appId: "1:1067832584063:web:4f2c12e7374ccfeea75c4a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const messaging = firebase.messaging();
        const tasksRef = db.ref('tasks');

        let tasks = [];
        let dayFilter = 'All';
        const ADMIN_PIN = "1234";

        function init() {
            tasksRef.on('value', (snapshot) => {
                const data = snapshot.val();
                tasks = [];
                for (let id in data) { tasks.push({ id, ...data[id] }); }
                render();
                updateSmartStats();
            });
        }

        function setDayFilter(day, el) {
            dayFilter = day;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            render();
            updateSmartStats();
        }

        function updateSmartStats() {
            let filtered = tasks;
            if (dayFilter !== 'All') filtered = filtered.filter(t => t.day === dayFilter);
            const total = filtered.length;
            const done = filtered.filter(t => t.completed).length;
            const p = total > 0 ? Math.round((done / total) * 100) : 0;
            document.getElementById('progressBar').style.width = p + '%';
            document.getElementById('percentLabel').innerText = p + '%';
        }

        function addTask() {
            const job = document.getElementById('jobSelect').value;
            const person = document.getElementById('nameSelect').value;
            if (dayFilter === 'All') return alert("Select a specific day (Mon-Sun) first!");
            tasksRef.push({ job, person, day: dayFilter, completed: false });
        }

        function toggleDone(id, status) { db.ref('tasks/' + id).update({ completed: !status }); }

        function removeTask(id) {
            if (prompt("Admin PIN:") === ADMIN_PIN) db.ref('tasks/' + id).remove();
        }

        function resetWeek() {
            if (prompt("This will clear ALL tasks. Pin:") === ADMIN_PIN) tasksRef.remove();
        }

        function requestNotificationPermission() {
            messaging.requestPermission().then(() => messaging.getToken())
            .then(token => alert("Notifications Active! Token: " + token.substring(0,8) + "..."))
            .catch(err => alert("Permission denied or blocked. Check browser settings."));
        }

        function openSettings() { document.getElementById('settingsOverlay').style.display = 'block'; }
        function closeSettings() { document.getElementById('settingsOverlay').style.display = 'none'; }

        function render() {
            const display = document.getElementById('mainDisplay');
            display.innerHTML = '';
            const daysOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            
            daysOrder.forEach(day => {
                if (dayFilter !== 'All' && dayFilter !== day) return;
                const dTasks = tasks.filter(t => t.day === day);
                if (dTasks.length === 0) return;

                let html = `<div class="day-card"><div class="day-header">${day}</div>`;
                dTasks.forEach(t => {
                    html += `
                    <div class="task-item ${t.completed ? 'completed' : ''}">
                        <div style="font-weight:800; font-size:0.7rem; color:var(--primary);">${t.person}</div>
                        <div style="font-weight:700; font-size:0.95rem; margin:5px 0;">${t.job}</div>
                        <div style="display:flex; gap:10px;">
                            <button style="background:var(--success); flex:1; padding:10px; border-radius:8px;" onclick="toggleDone('${t.id}', ${t.completed})">
                                ${t.completed ? 'âœ… Done' : 'Complete'}
                            </button>
                            <button style="background:var(--danger); width:50px; border-radius:8px;" onclick="removeTask('${t.id}')">ðŸ—‘</button>
                        </div>
                    </div>`;
                });
                display.innerHTML += html + `</div>`;
            });
        }

        init();
    </script>
</body>
</html>
